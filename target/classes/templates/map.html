<html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title></title>
    <script src="http://api-maps.yandex.ru/2.1/?lang=ru-RU" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <style>
        body, html {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 80%;
        }
    </style>
</head>

<body>
<div th:if="${nopoints}" th:utext="${nopoints}" style="color: red"></div>
<div id="map"></div>
<div id="color"></div>
<div id="note"></div>
<script th:inline="javascript">
    var precision = 30;
    var map;
    var points = [];
    var polygon;
    var zoom;
    var projection;
    var center;
    var radius;

    var listWithLevels=[[${listWithLevels}]];
    var azimuthOfSector=[[${azimuthOfsector}]];

    var cellss=[[${cells}]];
    var pointsInPos=[[${pointss}]];
    var latPos=[[${lat}]];
    var lonPos=[[${lon}]];
    var rad=[[${radius}]];
    var pos=[[${pos}]];
    var about=[[${about}]];
    var colorSet=[[${colorSet}]];
    document.title=pos+" "+about;

    function init() {
        map = new ymaps.Map("map", {
            center: [latPos, lonPos],
            zoom: 15
        });
        zoom = map.getZoom();
        projection = map.options.get('projection');
        center = projection.toGlobalPixels([latPos, lonPos], zoom);
        radius = rad*500/1300;


        if (listWithLevels!==null){

            //alert(listWithLevels.length);
            for (i = 0; i < cellss.length; i++) {
                if (cellss[i].azimuth===azimuthOfSector) {
                    createsectors(cellss[i].azimuth, "#FF0000", 0, 1);
                }
                else {
                    createsectors(cellss[i].azimuth, "#808080", 0, 1);
                }
            }
            for (i=0;i<listWithLevels.length;i++) {
                if (listWithLevels[i].param !== null) {
                    //alert(listWithLevels[i].longitude+" "+listWithLevels[i].language+" "+listWithLevels[i].color+" "+listWithLevels[i].param);
                    createPoint(listWithLevels[i].longitude, listWithLevels[i].latitude, listWithLevels[i].color, listWithLevels[i].param);
                }
            }
            var divColor = document.getElementById("color");


            for (i=colorSet.length-1;i>=0;i--){
                var canvas = document.createElement("canvas");
                canvas.width=10;
                canvas.height=10;
                var context=canvas.getContext("2d");
                context.arc(5,5,5,0,Math.PI*2,false);
                context.fillStyle=colorSet[i].split(" ")[1];
                context.fill();
                divColor.appendChild(canvas);
                divColor.appendChild(document.createElement("label").appendChild(document.createTextNode(colorSet[i].split(" ")[0])));
                divColor.appendChild(document.createElement("br"));
            }

        }
        else {

            for (i = 0; i < cellss.length; i++) {
                createsectors(cellss[i].azimuth, cellss[i].color, cellss[i].ci,0);
            }

            for (i = 0; i < pointsInPos.length; i++) {
                createPoint(pointsInPos[i].longitude, pointsInPos[i].latitude, pointsInPos[i].color, pointsInPos[i].param);
            }
        }

    }

    function createsectors(az, color, number, strokeWidth) {
        // вычисляем точки полигона в глобальных координатах
        var start = (az-90-30)*Math.PI/180;
        var end = (az-90+30)*Math.PI/180;

        var delta = end - start;
        var step = delta / precision;

        points.push(center);
        for(var i = 0; i <= delta + step; i += step){
            points.push([
                center[0] + radius * Math.cos(start + i),
                center[1] + radius * Math.sin(start + i)
            ]);
        }
        points.push(center);

        // переводим глобальные координаты в широту-долготу
        points = points.map(function (point) {
            return projection.fromGlobalPixels(point, zoom);
        });

        polygon = new ymaps.Polygon([points],{
            hintContent: number
        }, {
            fillColor: color,
            // Делаем полигон прозрачным для событий карты.
            interactivityModel: 'default#transparent',
            strokeWidth: 0,
            opacity: 0.5
        });

        map.geoObjects.add(polygon);
    }

    function createPoint(lon,lat,color,param) {
        // Создаем круг.
        // Создаем круг.
        var myCircle = new ymaps.Circle([
            // Координаты центра круга.
            [lat, lon],
            // Радиус круга в метрах.
            5
        ], {
            // Описываем свойства круга.
            // Содержимое балуна.
            balloonContent: "",
            // Содержимое хинта.
            hintContent: param
        }, {
            // Задаем опции круга.
            // Включаем возможность перетаскивания круга.
            draggable: false,
            // Цвет заливки.
            // Последний байт (77) определяет прозрачность.
            // Прозрачность заливки также можно задать используя опцию "fillOpacity".
            fillColor: color,
            // Цвет обводки.
            strokeColor: "#990066",
            // Прозрачность обводки.
            strokeOpacity: 0.8,
            // Ширина обводки в пикселях.
            strokeWidth: 0
        });

        // Добавляем круг на карту.
        map.geoObjects.add(myCircle);

    }

    ymaps.ready(init);


    for (i=0;i<cellss.length;i++){
        $('#note').append('<a href="/map?about='+ about + '&posName='+pos+'&cell='+cellss[i].ci+'">посмотреть сектор '+cellss[i].ci+' азимут: '+cellss[i].azimuth+'</a><br>');
    }
    $('#note').append('<a href="/map?about='+ about + '&posName='+pos+'">посмотреть все </a><br>');


</script>
</body>

</html>